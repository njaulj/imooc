#!/usr/bin/env node
var imooc = require('../src');
var opt = require('optimist');
var color = require('colors');
var prettyjson = require('prettyjson');
var argv = opt
    .usage("[Usage]\n\n imooc [command|keyword]\n\nCommands:")
    .argv;

switch (argv._[0]) {
    case 's':
    case 'search':
        argv = opt
            .usage("imooc " + argv._[0] + " [keyword]")
            .argv;

        var keyword = argv._[1];
        if (!keyword || argv.help) {
            opt.showHelp();
            return;
        }
        keyword = keyword.trim();
        imooc.search(keyword, function(err, data) {
            if (err) return imooc.error(err);
            if (data.length == 0) {
                return printLn('暂时没有你要找的课程');
            }
            printLn("搜索 " + keyword.bold + " 共有 " + (data.length + "").bold + " 门相关课程。");
            printLn("");

            data.forEach(function(item) {
                printLn(padString(item.id, 3).grey + " " + item.name.replace(keyword, keyword.bold));
            });
        });
    break;
    case 'l':
    case 'list':
        argv = opt
            .usage('imooc ' + argv._[0] + ' [-p pageNumber]')
            .argv;
        var page = argv.p || '1';
        imooc.list(page, function(err, data) {
            if (err) return imooc.error(err);
            if (data.length == 0) {
                return printLn('暂时没有课程');
            }
            printLn('热门课程如下，共有 ' + (data.length+'').bold + ' 门课。');
            printLn("");

            data.forEach(function(item) {
                console.log(prettyjson.render({
                    "课程号": item.id,
                    "课程名称": item.name,
                    "课程描述": item.desc,
                    "时长": (item.duration/(1000*60*60)).toFixed(2) + '小时'
                }));
                printLn("");
            });
        });
    break;
    case 'g':
    case 'get':
        argv = opt
            .usage('imooc ' + argv._[0] + 'courseid -c [chapters]')
            .argv;

        var cid = argv._[1],
            chapters = argv.c;
        // chapters.map(function(item) {
        //     return (item+'').trim();
        // });
        // console.log(chapters);
    break;
    default:
        if (argv.version || argv.v) {
            var json = require('../package.json');
            printLn(json.version);
        } else {
            opt.showHelp();
        }
    break;
}

function padString(str, num) {
    var len = (str+'').length;
    return len < num ? Array(num-len+1).join(' ') + str : str + '';
}

function printLn() {
    var args = [].slice.call(arguments, 0);
    args[0] = "  " + args[0];
    console.log.apply(this, args);
    return true;
}
